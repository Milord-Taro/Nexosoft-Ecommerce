{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mi perfil – Nexosoft</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Fuente -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Reutilizamos login.css para cards / botones -->
  <link rel="stylesheet" href="{% static 'css/login.css' %}">

  <style>
    .perfil-wrapper {
      max-width: 900px;
      margin: 32px auto 48px;
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.5fr);
      gap: 24px;
      font-family: Montserrat, sans-serif;
    }
    .perfil-card,
    .perfil-side-card {
      background: #ffffff;
      border-radius: 18px;
      padding: 20px 24px;
      box-shadow: 0 4px 14px rgba(15, 23, 42, 0.08);
    }
    .perfil-title {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 8px;
      color: #111827;
    }
    .perfil-subtitle {
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 16px;
    }
    .perfil-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px 16px;
    }
    .perfil-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .perfil-input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
      outline: none;
    }
    .perfil-input:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 1px rgba(99, 102, 241, 0.3);
    }
    .perfil-actions {
      margin-top: 16px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    .btn-primary-sm {
      background: #6366f1;
      color: #ffffff;
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .btn-primary-sm:hover {
      background: #4f46e5;
    }
    .btn-outline-sm {
      background: transparent;
      color: #4b5563;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 8px 16px;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .btn-outline-sm:hover {
      background: #f3f4f6;
    }
    .delete-warning {
      font-size: 0.85rem;
      color: #991b1b;
      margin-top: 10px;
      line-height: 1.4;
    }
    .delete-card-title {
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }
    .delete-card-text {
      font-size: 0.85rem;
      color: #4b5563;
      margin-bottom: 12px;
    }
    .btn-danger-sm {
      background: #dc2626;
      color: #ffffff;
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .btn-danger-sm:hover {
      background: #b91c1c;
    }

    .perfil-meta {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 8px;
    }

    .perfil-field-readonly {
      background: #f9fafb;
    }

    /* Mensajes */
    .auth-messages {
      max-width: 900px;
      margin: 16px auto 0;
    }
    .auth-message {
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 0.85rem;
      margin-bottom: 8px;
    }
    .auth-message.error {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }
    .auth-message.success,
    .auth-message.info {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }
  </style>
</head>
<body>
  <div class="app-wrapper">
    <!-- HEADER (puedes usar el mismo que en la landing) -->
    <header class="main-header">
      <div class="brand">
        <img src="{% static 'img/logo.png' %}" alt="NEXOSOFT Logo">
      </div>

      <div class="header-actions">
        <a href="{% url 'landing' %}" class="btn-outline">Volver a la tienda</a>
        <a href="{% url 'logout' %}" class="btn-primary">Cerrar sesión</a>
      </div>
    </header>

    <!-- MENSAJES -->
    {% if messages %}
    <div class="auth-messages">
      {% for message in messages %}
        <div class="auth-message {{ message.tags }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- CONTENIDO PERFIL -->
    <main class="perfil-wrapper">

      <!-- CARD IZQUIERDA: DATOS EDITABLES -->
      <section class="perfil-card">
        <h1 class="perfil-title">Mi perfil</h1>
        <p class="perfil-subtitle">
          Gestiona la información de tu cuenta de cliente.
        </p>

        <form id="perfilForm" method="post" action="{% url 'perfil' %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="update">

          <div class="perfil-grid">
            <!-- NOMBRES -->
            <div>
              <div class="perfil-label">Nombres</div>
              <input
                type="text"
                name="nombres"
                class="perfil-input"
                value="{{ usuario.nombres }}"
                required
              >
            </div>

            <!-- APELLIDOS -->
            <div>
              <div class="perfil-label">Apellidos</div>
              <input
                type="text"
                name="apellidos"
                class="perfil-input"
                value="{{ usuario.apellidos }}"
                required
              >
            </div>

            <!-- CORREO -->
            <div>
              <div class="perfil-label">Correo electrónico</div>
              <input
                type="email"
                name="correoElectronico"
                class="perfil-input"
                value="{{ usuario.correoElectronico }}"
                required
              >
            </div>

            <!-- TELÉFONO -->
            <div>
              <div class="perfil-label">Teléfono</div>
              <input
                type="tel"
                name="telefono"
                class="perfil-input"
                value="{{ usuario.telefono }}"
                required
              >
            </div>

            <!-- TIPO IDENTIFICACIÓN -->
            <div>
              <div class="perfil-label">Tipo de identificación</div>
              <select name="tipoIdentificacion" class="perfil-input" required>
                <option value="CC" {% if usuario.tipoIdentificacion == "CC" %}selected{% endif %}>CC</option>
                <option value="CE" {% if usuario.tipoIdentificacion == "CE" %}selected{% endif %}>CE</option>
                <option value="NIT" {% if usuario.tipoIdentificacion == "NIT" %}selected{% endif %}>NIT</option>
                <option value="PASAPORTE" {% if usuario.tipoIdentificacion == "PASAPORTE" %}selected{% endif %}>PASAPORTE</option>
                <option value="OTRO" {% if usuario.tipoIdentificacion == "OTRO" %}selected{% endif %}>OTRO</option>
              </select>
            </div>

            <!-- NÚMERO IDENTIFICACIÓN -->
            <div>
              <div class="perfil-label">Número de identificación</div>
              <input
                type="text"
                name="numeroIdentificacion"
                class="perfil-input"
                value="{{ usuario.numeroIdentificacion }}"
                required
              >
            </div>
          </div>

          <p class="perfil-meta">
            Estado de la cuenta: <b>{{ usuario.estadoCuenta }}</b><br>
            Rol: <b>{{ usuario.idRol }}</b>
          </p>

          <div class="perfil-actions">
            <button type="submit" class="btn-primary-sm">Guardar cambios</button>
          </div>
        </form>
      </section>

      <!-- CARD DERECHA: ELIMINAR CUENTA -->
      <aside class="perfil-side-card">
        <h2 class="delete-card-title">Solicitar eliminación de cuenta</h2>
        <p class="delete-card-text">
          Si ya no deseas usar Nexosoft, puedes solicitar la eliminación de tu cuenta.
          Esto marcará tu cuenta como <b>eliminada</b> y se cerrará tu sesión.
        </p>

        <form method="post" action="{% url 'perfil' %}" onsubmit="return confirm('¿Estás seguro de que deseas solicitar la eliminación de tu cuenta?');">
          {% csrf_token %}
          <input type="hidden" name="action" value="delete">

          <button type="submit" class="btn-danger-sm">
            Solicitar eliminación
          </button>
        </form>

        <p class="delete-warning">
          Esta acción desactivará tu cuenta y no podrás iniciar sesión nuevamente
          con estas credenciales.
        </p>
      </aside>

    </main>

    <footer class="site-footer">
      <div class="footer-bottom">
        <span>© 2025 NEXOSOFT. Todos los derechos reservados.</span>
      </div>
    </footer>
  </div>

  <script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("perfilForm");
  if (!form) return;

  // Todos los campos obligatorios dentro del formulario
  const campos = form.querySelectorAll("input[required], select[required]");

  function obtenerMensajeError(campo) {
    const v = campo.validity;
    const name = campo.name;

    // 1) Campo vacío
    if (v.valueMissing) {
      switch (name) {
        case "nombres":              return "Ingresa tus nombres.";
        case "apellidos":            return "Ingresa tus apellidos.";
        case "correoElectronico":    return "Ingresa tu correo electrónico.";
        case "telefono":             return "Ingresa tu número de celular.";
        case "tipoIdentificacion":   return "Selecciona un tipo de identificación.";
        case "numeroIdentificacion": return "Ingresa tu número de identificación.";
        default:                     return "Este campo es obligatorio.";
      }
    }

    // 2) Tipo email incorrecto
    if (v.typeMismatch && campo.type === "email") {
      return "Ingresa un correo electrónico válido.";
    }

    // 3) Longitud mínima / máxima
    if (v.tooShort || v.tooLong) {
      switch (name) {
        case "nombres":
        case "apellidos":
          return "Este campo debe tener entre 2 y 60 caracteres.";
        case "numeroIdentificacion":
          return "El número de identificación debe tener entre 5 y 15 dígitos.";
        case "telefono":
          return "El número de celular debe tener 10 dígitos.";
        default:
          return "La longitud del valor no es válida.";
      }
    }

    // 4) Pattern / regex
    if (v.patternMismatch) {
      switch (name) {
        case "nombres":
        case "apellidos":
          return "Solo se permiten letras y espacios en este campo.";
        case "numeroIdentificacion":
          return "El número de identificación debe contener solo dígitos (5 a 15).";
        case "correoElectronico":
          return "Ingresa un correo válido (gmail, hotmail, outlook o yahoo).";
        case "telefono":
          return "El celular debe empezar por 3 y tener 10 dígitos.";
        default:
          return "El formato de este campo no es válido.";
      }
    }

    // 5) Todo ok
    return "";
  }

  function mostrarError(campo, mensaje) {
    campo.classList.add("input-error");

    let errorDiv = campo.parentElement.querySelector(".field-error");
    if (!errorDiv) {
      errorDiv = document.createElement("div");
      errorDiv.className = "field-error";
      campo.parentElement.appendChild(errorDiv);
    }
    errorDiv.textContent = mensaje;
  }

  function limpiarError(campo) {
    campo.classList.remove("input-error");
    const errorDiv = campo.parentElement.querySelector(".field-error");
    if (errorDiv) {
      errorDiv.textContent = "";
    }
  }

  function validarCampo(campo) {
    // Desactivamos globos nativos del navegador
    campo.setCustomValidity("");

    const mensaje = obtenerMensajeError(campo);

    if (mensaje) {
      mostrarError(campo, mensaje);
      return false;
    } else {
      limpiarError(campo);
      return true;
    }
  }

  // Validar al enviar
  form.addEventListener("submit", (e) => {
    let valido = true;
    let primeroInvalido = null;

    campos.forEach((campo) => {
      const ok = validarCampo(campo);
      if (!ok && !primeroInvalido) {
        primeroInvalido = campo;
        valido = false;
      }
    });

    if (!valido) {
      e.preventDefault();
      if (primeroInvalido) primeroInvalido.focus();
    }
  });

  // Validar mientras escribe
  campos.forEach((campo) => {
    campo.addEventListener("input", () => validarCampo(campo));
  });
});
</script>
</body>
</html>
