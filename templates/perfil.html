{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mi perfil – Nexosoft</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Fuente -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Reutilizamos login.css para cards / botones -->
  <link rel="stylesheet" href="{% static 'css/login.css' %}">

</head>
<body>
  <div class="app-wrapper">
    <!-- HEADER (puedes usar el mismo que en la landing) -->
    <header class="main-header">
      <div class="brand">
        <a href="{% url 'landing' %}">
          <img src="{% static 'img/logo.png' %}" alt="NEXOSOFT Logo">
        </a>
      </div>

      <div class="header-actions">
        <a href="{% url 'landing' %}" class="btn-outline">Volver a la tienda</a>
        <a href="{% url 'logout' %}" class="btn-primary">Cerrar sesión</a>
      </div>
    </header>

    <!-- MENSAJES -->
    {% if messages %}
    <div class="auth-messages">
      {% for message in messages %}
        <div class="auth-message {{ message.tags }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- CONTENIDO PERFIL -->
      <!-- CONTENIDO PRINCIPAL -->
  <main>
    <section class="perfil-section">
      <div class="perfil-wrapper">

        <!-- SIDEBAR IZQUIERDO -->
        <aside class="perfil-sidebar">
          <h2 class="perfil-sidebar-title">Mi cuenta</h2>
          <nav class="perfil-menu">
            <a href="{% url 'perfil' %}"
            class="perfil-menu-item {% if active_section == 'perfil' %}perfil-menu-item--active{% endif %}">
           Datos personales
         </a>
       
         <a href="{% url 'direcciones' %}"
            class="perfil-menu-item {% if active_section == 'direcciones' %}perfil-menu-item--active{% endif %}">
           Direcciones de envío
         </a>
       
         <button type="button" class="perfil-menu-item" disabled>
           Mis pedidos
         </button>
         <button type="button" class="perfil-menu-item" disabled>
           Seguridad
         </button>
       </nav>
      </aside>
       
        <!-- COLUMNA DERECHA: CONTENIDO -->
        <div class="perfil-main">

          <!-- CARD: DATOS PERSONALES (tu formulario actual) -->
          <section class="perfil-main-card">
            <h1 class="perfil-title">Mi perfil</h1>
            <p class="perfil-subtitle">
              Gestiona la información de tu cuenta de cliente.
            </p>

            <form method="post" class="perfil-form">
              {% csrf_token %}
              <input type="hidden" name="action" value="update">

              <div class="perfil-grid">
                <div class="perfil-field">
                  <label for="id_nombres">Nombres</label>
                  <input
                    type="text"
                    id="id_nombres"
                    name="nombres"
                    value="{{ usuario.nombres|default_if_none:'' }}"
                    required
                  >
                </div>

                <div class="perfil-field">
                  <label for="id_apellidos">Apellidos</label>
                  <input
                    type="text"
                    id="id_apellidos"
                    name="apellidos"
                    value="{{ usuario.apellidos|default_if_none:'' }}"
                    required
                  >
                </div>

                <div class="perfil-field">
                  <label for="id_correo">Correo electrónico</label>
                  <input
                    type="email"
                    id="id_correo"
                    name="correoElectronico"
                    value="{{ usuario.correoElectronico|default_if_none:'' }}"
                    required
                  >
                </div>

                <div class="perfil-field">
                  <label for="id_telefono">Teléfono</label>
                  <input
                    type="text"
                    id="id_telefono"
                    name="telefono"
                    value="{{ usuario.telefono|default_if_none:'' }}"
                    required
                  >
                </div>

                <div class="perfil-field">
                  <label for="id_tipo_ident">Tipo de identificación</label>
                  <select id="id_tipo_ident" name="tipoIdentificacion" required>
                    <option value="">Selecciona...</option>
                    <option value="CC" {% if usuario.tipoIdentificacion == "CC" %}selected{% endif %}>Cédula de ciudadanía</option>
                    <option value="TI" {% if usuario.tipoIdentificacion == "TI" %}selected{% endif %}>Tarjeta de identidad</option>
                    <option value="CE" {% if usuario.tipoIdentificacion == "CE" %}selected{% endif %}>Cédula de extranjería</option>
                    <option value="NIT" {% if usuario.tipoIdentificacion == "NIT" %}selected{% endif %}>NIT</option>
                  </select>
                </div>

                <div class="perfil-field">
                  <label for="id_num_ident">Número de identificación</label>
                  <input
                    type="text"
                    id="id_num_ident"
                    name="numeroIdentificacion"
                    value="{{ usuario.numeroIdentificacion|default_if_none:'' }}"
                    required
                  >
                </div>
              </div>

              <div class="perfil-footer">
                <button type="submit" class="btn-primary">
                  Guardar cambios
                </button>
              </div>
            </form>
          </section>

          <!-- CARD: SOLICITAR ELIMINACIÓN -->
          <aside class="perfil-side-card">
            <h2 class="perfil-side-title">Solicitar eliminación de cuenta</h2>
            <p class="perfil-side-text">
              Si ya no deseas usar Nexosoft, puedes solicitar la eliminación de tu cuenta.
              Esto marcará tu cuenta como <strong>eliminada</strong> y cerrará tu sesión.
            </p>

            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="action" value="delete">
              <button type="submit" class="btn-danger">
                Solicitar eliminación
              </button>
            </form>

            <p class="perfil-side-note">
              Esta acción desactivará tu cuenta y no podrás iniciar sesión de nuevo
              con estas credenciales.
            </p>
          </aside>

        </div>
      </div>
    </section>
  </main>


    <footer class="site-footer">
      <div class="footer-bottom">
        <span>© 2025 NEXOSOFT. Todos los derechos reservados.</span>
      </div>
    </footer>
  </div>

  <script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("perfilForm");
  if (!form) return;

  // Todos los campos obligatorios dentro del formulario
  const campos = form.querySelectorAll("input[required], select[required]");

  function obtenerMensajeError(campo) {
    const v = campo.validity;
    const name = campo.name;

    // 1) Campo vacío
    if (v.valueMissing) {
      switch (name) {
        case "nombres":              return "Ingresa tus nombres.";
        case "apellidos":            return "Ingresa tus apellidos.";
        case "correoElectronico":    return "Ingresa tu correo electrónico.";
        case "telefono":             return "Ingresa tu número de celular.";
        case "tipoIdentificacion":   return "Selecciona un tipo de identificación.";
        case "numeroIdentificacion": return "Ingresa tu número de identificación.";
        default:                     return "Este campo es obligatorio.";
      }
    }

    // 2) Tipo email incorrecto
    if (v.typeMismatch && campo.type === "email") {
      return "Ingresa un correo electrónico válido.";
    }

    // 3) Longitud mínima / máxima
    if (v.tooShort || v.tooLong) {
      switch (name) {
        case "nombres":
        case "apellidos":
          return "Este campo debe tener entre 2 y 60 caracteres.";
        case "numeroIdentificacion":
          return "El número de identificación debe tener entre 5 y 15 dígitos.";
        case "telefono":
          return "El número de celular debe tener 10 dígitos.";
        default:
          return "La longitud del valor no es válida.";
      }
    }

    // 4) Pattern / regex
    if (v.patternMismatch) {
      switch (name) {
        case "nombres":
        case "apellidos":
          return "Solo se permiten letras y espacios en este campo.";
        case "numeroIdentificacion":
          return "El número de identificación debe contener solo dígitos (5 a 15).";
        case "correoElectronico":
          return "Ingresa un correo válido (gmail, hotmail, outlook o yahoo).";
        case "telefono":
          return "El celular debe empezar por 3 y tener 10 dígitos.";
        default:
          return "El formato de este campo no es válido.";
      }
    }

    // 5) Todo ok
    return "";
  }

  function mostrarError(campo, mensaje) {
    campo.classList.add("input-error");

    let errorDiv = campo.parentElement.querySelector(".field-error");
    if (!errorDiv) {
      errorDiv = document.createElement("div");
      errorDiv.className = "field-error";
      campo.parentElement.appendChild(errorDiv);
    }
    errorDiv.textContent = mensaje;
  }

  function limpiarError(campo) {
    campo.classList.remove("input-error");
    const errorDiv = campo.parentElement.querySelector(".field-error");
    if (errorDiv) {
      errorDiv.textContent = "";
    }
  }

  function validarCampo(campo) {
    // Desactivamos globos nativos del navegador
    campo.setCustomValidity("");

    const mensaje = obtenerMensajeError(campo);

    if (mensaje) {
      mostrarError(campo, mensaje);
      return false;
    } else {
      limpiarError(campo);
      return true;
    }
  }

  // Validar al enviar
  form.addEventListener("submit", (e) => {
    let valido = true;
    let primeroInvalido = null;

    campos.forEach((campo) => {
      const ok = validarCampo(campo);
      if (!ok && !primeroInvalido) {
        primeroInvalido = campo;
        valido = false;
      }
    });

    if (!valido) {
      e.preventDefault();
      if (primeroInvalido) primeroInvalido.focus();
    }
  });

  // Validar mientras escribe
  campos.forEach((campo) => {
    campo.addEventListener("input", () => validarCampo(campo));
  });
});
</script>
</body>
</html>
